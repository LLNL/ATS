# ATS Release Notes

##  7.0.113

    Better Flux support for Native Flux machines with GPUs, 
    such as rzvernal.

    Note that the MACHINE_TYPE is flux00.  You will need
    to set that in your environment (or have your ATS wrapper
    set that MACHINE_TYPE env var). 

    Note: 'flux run help' is quite useful to understand
    flux run options. 

    Removed hard coded flux options such as "-o cpu-affinity=per-task"
    and "-o mpibind=off" and "--exclusive".  These vary too much
    by project.   Please see the option flux_run_args, documented
    below, to add project specific options to the flux run line.

    Removed use of deprecated 'flux mini run', just use 'flux run' 

    Added test_np_max (see below) for flux as well as other schedulers.

    --------------------------------------------------------------
    P E R   T E S T   O P T I O N S

    At the individual test level, these are useful options
    when using Flux:

    Note that this release of ATS supports Per-Task flux options
    at this time.  We are considering how to add support for
    Per-resource options in the next release.
    
    nn  Number of Nodes for the test.  Translates
        to the -N option for flux and other schedulers.
    
    np  Number of MPI Ranks for the test. Translates to
        the -n option for flux and other schedulers.
    
    nt  Number of threads per MPI rank.  Will be used to set 
        the environment variable OMP_NUM_THREADS
        for the test run, as well as calculate the number of CPU
        cores reserved for each MPI rank.  This will be used to 
        set the -c flux option, which is the number of cores
        per process.

    gpus_per_task/ngpu

        The ngpu option, while still honored, is being replaced
        by the more specific gpus_per_task option.   

        Number of GPU Devides per MPI Rank.  This will be
        used to set the -c flux option in order to provide a separate
        GPU for each MPI Rank.  It is not currently used to
        set the flux -g option, as in our testing, that was
        not sufficient, nor necessary, in order to allocates
        separate GPUS for each MPI rank.

    Note that both the nt and the gpus_per_task option will 
    result in a -c option that is greater 1, which will reduce
    the number of concurrent MPI ranks that can run on a node.  This
    is by design, as ATS does not want to have concurrent tests time 
    sharing resources, either CPUS or GPUS. 
    
    --------------------------------------------------------------
    A T S   C O M M A N D   L I N E   F L U X   O P T I O N S

    ats --help:    will show all command lineoptions.
    flux run help: will show flux run options which may be useful
    
    Running ats with the --verbose option is an easy method
    to see the flux run line generated by ATS.

    In addition to the test level ATS options above, One may 
    use command line options to over-ride those, or append to
    them, or to add project specific options to the flux
    run line.  

    Here are some particularly useful ATS options when using
    the flux scheduler.
    
    --flux_run_args="some string"

        This can be used to add any string that is meaningful to
        the basic 'flux run' command to each test submittal.
        For instance:

        --flux_run_args="-o gpu-affinity=per-task --exclusiive"

        Would add that the basic flux run line that ats generates.

    --nn  Over-rides or appends test specific nn  option.

    --test_np_max   Potentially over-rides the np test setting. 
        That is, it limits the maximum value of np to this value.
        If the test np is less than this value, then no change
        If the test np is greater than this value, then the test np
        is reduced to this value.

        For instance if the command line option --test_np_max=4
        is used, then a per test setting of np=10 will be reduced 
        to np=4.  If a per test setting of np=1 is in the test deck,
        then it will not be changed.

    --gpus_per_task  Over-rides or appends the test specific gpus_per_task
        option.  

    ------------------------------------------------------------------
    E X A M P L E   A T S   G P U   T E S T I N G   W I T H   F L U X

    As an example, here are some command line settings a project used
    to run a large test suite using Flux.  While the tests specify the
    options np and nt, they do not specify the gpus_per_task.  And
    they have many tests with a large number for np.   The desire is
    to run on a machine which has 8 GPU and 64 cores per node.  In
    addition, the project testing goal is to achieve throughput by 
    running two concurrent jobs on each node 

    For this project the ats test run line used is:

    --test_np_max=4 --gpus_per_task=1 --timelimit=10m

    As there are 8 GPUs set of ATS options allows for each test to
    run with 4 MPI ranks, each of which has 1 GPU.   Thus flux should
    be able to drive two jobs concurrently on each node of the allocation.

    In addition, this project is still porting to the GPUs and there are
    some jobs which appeared to hang.   So the additionaal --timelimit
    option was specified in order to have flux kill possibly hung test 
    jobs and continue with other tests. 

    This set of options resulted in actual flux run lines, generated
    by ATS which look like so:

    flux run -t10m -n4 -c8  <etc>

    Note that the -c8 setting ensures a separate GPU for each MPI rank.

    Additionally there was a small change to the ATS blueOS wrapper (lsf):
        Options --lrun_np_max and --jsrun_np_max are being deprecated and
        are repaced by a single option --test_np_max to be uniform
        throughout ATS

## 7.0.111
    Inital Flux support on Toss 4 systems where flux is 
    the native scheduler.   

    Only call 'stty sane' if ENVIRONMENT env var is INTERACTIVE
    This call results in warnings and such if in a BATCH
    environment.

    pip installs ats with poetry, not setuptools (#97)
    * pip installs ats with poetry, not setuptools
    * remove outdated bin dir files
    * rename back to atsflux

## 7.0.105

    Update sleepBeforeRun option.
    Renamed from sleepBeforeSrun.
    Still honor sleepBeforeSrun, simply map
    to sleepBeforeRun.
    Change value given to this option from an int to a float.
    
    Add tossrun for VIP project usage.

    Fix globalPostrunScript and globalPrerunScript processing.
    
    Strip quotes which are somehow addedd to the string in Python3
    Otherwise we can not verify the file exists or execute it.
    
    Default ruby machine type to slurm56

    For slurm:
    Account for slurm version such as 21.08.8-2
    
    Added --useMinNodes for toss (slurm)
    
    If --useMinNodes specified, then within an allocation
    specify
    
        srun_nodes="--nodes=%i-%i" % (minNodes, minNodes)
    
    when starting the job, where minNodes is the minimum
    number of nodes needed for the requested number of MPI
    processes.   This is experimental at this point,
    and may lead to hangs or lower throughput.

    For blueos:
    Add smpi options to ats command line
    
    Either one of these may be used to disable the --smpiargs="-gpu" option.
    
    --smpi_off
    --smpi_show


## 7.0.100

* Port to Python 3.8

## 7.0 

* 2021-April-19
* Migrated from Bitbucket to GitHub


